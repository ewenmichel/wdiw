{% extends "base.html" %}

{% block title %}
{% if company %}Éditer {{ company.name }}{% else %}Nouvelle entreprise{% endif %} - Tech Companies Database
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h2 style="color: #64b5f6;">
        {% if company %}Éditer {{ company.name }}{% else %}Nouvelle entreprise{% endif %}
    </h2>
    <a href="{% if company %}/companies/{{ company.id }}{% else %}/{% endif %}" class="btn btn-secondary">← Annuler</a>
</div>

<form id="companyForm" method="post" action="{% if company %}/companies/{{ company.id }}/edit{% else %}/companies/new{% endif %}" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    <!-- Main Form -->
    <div>
        <div class="card">
            <h3 style="color: #64b5f6; margin-bottom: 1rem;">Informations de base</h3>
            
            <div class="grid-2">
                <div class="form-group">
                    <label for="name">Nom de l'entreprise *</label>
                    <input type="text" id="name" name="name" required 
                           value="{% if company %}{{ company.name }}{% endif %}">
                </div>
                <div class="form-group">
                    <label for="website">Site web</label>
                    <input type="url" id="website" name="website" 
                           value="{% if company %}{{ company.website or '' }}{% endif %}">
                </div>
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" rows="3">{% if company %}{{ company.description or '' }}{% endif %}</textarea>
            </div>

            <!-- SECTEUR TAGS -->
            <div class="form-group">
                <label>Secteur</label>
                <div class="tag-container" data-category="secteur">
                    <div class="tag-display" id="secteur-tags">
                        {% if company and company.get_secteur_tags() %}
                            {% for tag in company.get_secteur_tags() %}
                            <span class="tag" data-tag="{{ tag.name }}" style="background-color: {{ tag.color }}20; color: {{ tag.color }}; border: 1px solid {{ tag.color }}40;">
                                {{ tag.name }}
                                <button type="button" class="tag-remove" onclick="removeTag(this)">×</button>
                            </span>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <input type="text" class="tag-input" placeholder="Tapez un secteur et appuyez sur Entrée..." data-category="secteur">
                </div>
            </div>
            
            <!-- CORE BUSINESS TAGS -->
            <div class="form-group">
                <label>Core Business</label>
                <div class="tag-container" data-category="core_business">
                    <div class="tag-display" id="core_business-tags">
                        {% if company and company.get_core_business_tags() %}
                            {% for tag in company.get_core_business_tags() %}
                            <span class="tag" data-tag="{{ tag.name }}" style="background-color: {{ tag.color }}20; color: {{ tag.color }}; border: 1px solid {{ tag.color }}40;">
                                {{ tag.name }}
                                <button type="button" class="tag-remove" onclick="removeTag(this)">×</button>
                            </span>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <input type="text" class="tag-input" placeholder="Tapez un core business et appuyez sur Entrée..." data-category="core_business">
                </div>
            </div>

            <div class="form-group">
                <label for="location">Localisation</label>
                <input type="text" id="location" name="location" 
                       value="{% if company %}{{ company.location or '' }}{% endif %}">
            </div>
        </div>

        <div class="card">
            <h3 style="color: #64b5f6; margin-bottom: 1rem;">Critères personnalisés</h3>
            
            <div class="grid-4">
                <div class="form-group">
                    <label for="high_profile">High Profile (1-5)</label>
                    <input type="range" id="high_profile" name="high_profile" min="1" max="5" 
                           value="{% if company %}{{ company.high_profile }}{% else %}3{% endif %}">
                    <span id="high_profile_display">{% if company %}{{ company.high_profile }}{% else %}3{% endif %}/5</span>
                </div>
                <div class="form-group">
                    <label for="remuneration">Rémunération (1-5)</label>
                    <input type="range" id="remuneration" name="remuneration" min="1" max="5" 
                           value="{% if company %}{{ company.remuneration or 3 }}{% else %}3{% endif %}">
                    <span id="remuneration_display">
                        {% if company and company.remuneration %}
                            {% if company.remuneration == 1 %}Underpaying
                            {% elif company.remuneration == 2 %}Below Market
                            {% elif company.remuneration == 3 %}At Market
                            {% elif company.remuneration == 4 %}Over Market
                            {% elif company.remuneration == 5 %}Overpaying
                            {% endif %}
                        {% else %}At Market{% endif %}
                    </span>
                </div>
                <div class="form-group">
                    <label for="work_intensity">Work Intensity</label>
                    <select id="work_intensity" name="work_intensity">
                        <option value="chill" {% if company and company.work_intensity == 'chill' %}selected{% endif %}>Chill</option>
                        <option value="balanced" {% if not company or company.work_intensity == 'balanced' %}selected{% endif %}>Balanced</option>
                        <option value="intense" {% if company and company.work_intensity == 'intense' %}selected{% endif %}>Intense</option>
                        <option value="bourrin" {% if company and company.work_intensity == 'bourrin' %}selected{% endif %}>Bourrin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="company_size">Taille</label>
                    <select id="company_size" name="company_size">
                        <option value="early" {% if company and company.company_size == 'early' %}selected{% endif %}>Early (0-10)</option>
                        <option value="startup" {% if not company or company.company_size == 'startup' %}selected{% endif %}>Startup (10-50)</option>
                        <option value="scaleup" {% if company and company.company_size == 'scaleup' %}selected{% endif %}>Scale-up (50-200)</option>
                        <option value="corp" {% if company and company.company_size == 'corp' %}selected{% endif %}>Corp (200+)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- FOUNDERS -->
        <div class="card">
            <h3 style="color: #64b5f6; margin-bottom: 1rem;">Founders</h3>
            <div id="founders-section">
                {% if company and company.founders %}
                    {% for founder in company.founders %}
                    <div class="founder-item" data-founder-id="{{ loop.index0 }}">
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Nom</label>
                                <input type="text" name="founder_name" value="{{ founder.name }}">
                            </div>
                            <div class="form-group">
                                <label>Titre</label>
                                <input type="text" name="founder_title" value="{{ founder.title or '' }}">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Type de background</label>
                            <select name="background_type" onchange="toggleBackgroundFields(this)">
                                <option value="">Sélectionner un type</option>
                                <option value="education" {% if founder.background_type == 'education' %}selected{% endif %}>Éducation</option>
                                <option value="professional" {% if founder.background_type == 'professional' %}selected{% endif %}>Professionnel</option>
                            </select>
                        </div>
                        
                        <!-- Education Background -->
                        <div class="education-fields" style="display: {% if founder.background_type == 'education' %}block{% else %}none{% endif %};">
                            <h4 style="color: #64b5f6;">Éducation</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Institution</label>
                                    <input type="text" name="education_institution" value="{{ founder.education_institution or '' }}">
                                </div>
                                <div class="form-group">
                                    <label>Diplôme</label>
                                    <input type="text" name="education_degree" value="{{ founder.education_degree or '' }}">
                                </div>
                            </div>
                            
                            <!-- EDUCATION TAGS -->
                            <div class="form-group">
                                <label>Écoles/Institutions</label>
                                <div class="tag-container" data-category="education" data-founder-id="{{ loop.index0 }}">
                                    <div class="tag-display" id="education-tags-{{ loop.index0 }}">
                                        {% if founder.get_education_tags %}
                                            {% for tag in founder.get_education_tags() %}
                                            <span class="tag" data-tag="{{ tag.name }}" style="background-color: {{ tag.color }}20; color: {{ tag.color }}; border: 1px solid {{ tag.color }}40;">
                                                {{ tag.name }}
                                                <button type="button" class="tag-remove" onclick="removeTag(this)">×</button>
                                            </span>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    <input type="text" class="tag-input" placeholder="Tapez une école et appuyez sur Entrée..." data-category="education" data-founder-id="{{ loop.index0 }}">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Professional Background -->
                        <div class="professional-fields" style="display: {% if founder.background_type == 'professional' %}block{% else %}none{% endif %};">
                            <h4 style="color: #64b5f6;">Expérience Professionnelle</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Entreprise</label>
                                    <input type="text" name="professional_company" value="{{ founder.professional_company or '' }}">
                                </div>
                                <div class="form-group">
                                    <label>Poste</label>
                                    <input type="text" name="professional_position" value="{{ founder.professional_position or '' }}">
                                </div>
                            </div>
                            
                            <!-- PROFESSIONAL TAGS -->
                            <div class="form-group">
                                <label>Entreprises précédentes</label>
                                <div class="tag-container" data-category="professional" data-founder-id="{{ loop.index0 }}">
                                    <div class="tag-display" id="professional-tags-{{ loop.index0 }}">
                                        {% if founder.get_professional_tags %}
                                            {% for tag in founder.get_professional_tags() %}
                                            <span class="tag" data-tag="{{ tag.name }}" style="background-color: {{ tag.color }}20; color: {{ tag.color }}; border: 1px solid {{ tag.color }}40;">
                                                {{ tag.name }}
                                                <button type="button" class="tag-remove" onclick="removeTag(this)">×</button>
                                            </span>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    <input type="text" class="tag-input" placeholder="Tapez une entreprise et appuyez sur Entrée..." data-category="professional" data-founder-id="{{ loop.index0 }}">
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-danger" onclick="removeFounder(this)">Supprimer</button>
                    </div>
                    {% endfor %}
                {% else %}
                    <!-- Default founder -->
                    <div class="founder-item" data-founder-id="0">
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Nom</label>
                                <input type="text" name="founder_name">
                            </div>
                            <div class="form-group">
                                <label>Titre</label>
                                <input type="text" name="founder_title">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Type de background</label>
                            <select name="background_type" onchange="toggleBackgroundFields(this)">
                                <option value="">Sélectionner un type</option>
                                <option value="education">Éducation</option>
                                <option value="professional">Professionnel</option>
                            </select>
                        </div>
                        
                        <!-- Education Background -->
                        <div class="education-fields" style="display: none;">
                            <h4 style="color: #64b5f6;">Éducation</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Institution</label>
                                    <input type="text" name="education_institution">
                                </div>
                                <div class="form-group">
                                    <label>Diplôme</label>
                                    <input type="text" name="education_degree">
                                </div>
                            </div>
                            
                            <!-- EDUCATION TAGS -->
                            <div class="form-group">
                                <label>Écoles/Institutions</label>
                                <div class="tag-container" data-category="education" data-founder-id="0">
                                    <div class="tag-display" id="education-tags-0"></div>
                                    <input type="text" class="tag-input" placeholder="Tapez une école et appuyez sur Entrée..." data-category="education" data-founder-id="0">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Professional Background -->
                        <div class="professional-fields" style="display: none;">
                            <h4 style="color: #64b5f6;">Expérience Professionnelle</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Entreprise</label>
                                    <input type="text" name="professional_company">
                                </div>
                                <div class="form-group">
                                    <label>Poste</label>
                                    <input type="text" name="professional_position">
                                </div>
                            </div>
                            
                            <!-- PROFESSIONAL TAGS -->
                            <div class="form-group">
                                <label>Entreprises précédentes</label>
                                <div class="tag-container" data-category="professional" data-founder-id="0">
                                    <div class="tag-display" id="professional-tags-0"></div>
                                    <input type="text" class="tag-input" placeholder="Tapez une entreprise et appuyez sur Entrée..." data-category="professional" data-founder-id="0">
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-danger" onclick="removeFounder(this)">Supprimer</button>
                    </div>
                {% endif %}
            </div>
            <button type="button" class="btn btn-secondary" onclick="addFounder()">+ Ajouter founder</button>
        </div>

        <!-- INVESTORS -->
        <div class="card">
            <h3 style="color: #64b5f6; margin-bottom: 1rem;">Investisseurs</h3>
            <div id="investors-section">
                {% if company and company.investors %}
                    {% for investor in company.investors %}
                    <div class="investor-item">
                        <input type="text" name="investor_name" value="{{ investor.name }}">
                        <button type="button" class="btn btn-danger" onclick="removeInvestor(this)">×</button>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="investor-item">
                        <input type="text" name="investor_name" placeholder="Nom de l'investisseur">
                        <button type="button" class="btn btn-danger" onclick="removeInvestor(this)">×</button>
                    </div>
                {% endif %}
            </div>
            <button type="button" class="btn btn-secondary" onclick="addInvestor()">+ Ajouter investisseur</button>
        </div>
    </div>

    <!-- Sidebar -->
    <div>
        <div class="card">
            <h3 style="color: #64b5f6; margin-bottom: 1rem;">Données financières</h3>
            
            <div class="form-group">
                <label for="founded_year">Année de création</label>
                <input type="number" id="founded_year" name="founded_year" min="1900" max="2030"
                       value="{% if company %}{{ company.founded_year or '' }}{% endif %}">
            </div>
            
            <div class="form-group">
                <label for="last_funding">Dernier funding</label>
                <input type="text" id="last_funding" name="last_funding" 
                       placeholder="ex: $30M Series A"
                       value="{% if company %}{{ company.last_funding or '' }}{% endif %}">
            </div>
        </div>

        <div style="display: flex; gap: 1rem;">
            <button type="submit" class="btn btn-primary" style="flex: 1;">
                {% if company %}Mettre à jour{% else %}Créer{% endif %}
            </button>
            {% if company %}
            <button type="button" class="btn btn-danger" onclick="deleteCompany()">
                Supprimer
            </button>
            {% endif %}
        </div>
    </div>
</form>

<script>
// SYSTÈME DE TAGS SIMPLIFIÉ ET FONCTIONNEL
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Initializing tag system...');
    initializeTagSystem();
    setupFormSubmission();
});

function initializeTagSystem() {
    // Attacher les événements à TOUS les inputs de tags
    document.querySelectorAll('.tag-input').forEach(input => {
        console.log(`Attaching events to input: ${input.dataset.category}`, input.dataset.founderId ? `founder-${input.dataset.founderId}` : 'company');
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                
                const tagName = input.value.trim();
                if (tagName) {
                    console.log(`Adding tag: "${tagName}" to ${input.dataset.category}`);
                    addTag(input, tagName);
                    input.value = '';
                }
                return false;
            }
        });
    });
    
    // Sliders
    document.getElementById('high_profile').addEventListener('input', function() {
        document.getElementById('high_profile_display').textContent = this.value + '/5';
    });

    const remunerationLabels = {1: 'Underpaying', 2: 'Below Market', 3: 'At Market', 4: 'Over Market', 5: 'Overpaying'};
    document.getElementById('remuneration').addEventListener('input', function() {
        document.getElementById('remuneration_display').textContent = remunerationLabels[this.value];
    });
}

function addTag(input, tagName) {
    const container = input.closest('.tag-container');
    const category = input.dataset.category;
    const founderId = input.dataset.founderId;
    
    // Trouver le tag display
    const tagDisplay = container.querySelector('.tag-display');
    
    // Vérifier si le tag existe déjà
    const existingTags = Array.from(tagDisplay.querySelectorAll('.tag')).map(tag => tag.dataset.tag);
    if (existingTags.includes(tagName)) {
        console.log(`Tag "${tagName}" already exists`);
        input.placeholder = `"${tagName}" existe déjà!`;
        setTimeout(() => {
            input.placeholder = input.getAttribute('placeholder') || 'Tapez et appuyez sur Entrée...';
        }, 2000);
        return;
    }
    
    // Créer le tag
    const tagElement = document.createElement('span');
    tagElement.className = 'tag';
    tagElement.dataset.tag = tagName;
    tagElement.style.cssText = 'background-color: #64b5f620; color: #64b5f6; border: 1px solid #64b5f640; padding: 0.25rem 0.75rem; border-radius: 16px; font-size: 0.8rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem; margin-right: 0.5rem; margin-bottom: 0.5rem;';
    tagElement.innerHTML = `
        ${tagName}
        <button type="button" class="tag-remove" onclick="removeTag(this)" style="background: none; border: none; color: inherit; cursor: pointer; padding: 0; margin-left: 0.25rem; font-size: 1rem; line-height: 1; opacity: 0.7;">×</button>
    `;
    
    tagDisplay.appendChild(tagElement);
    console.log(`✅ Added tag "${tagName}" to ${category}${founderId ? ` for founder ${founderId}` : ''}`);
    
    // Feedback visuel
    input.placeholder = `✅ "${tagName}" ajouté!`;
    setTimeout(() => {
        input.placeholder = input.getAttribute('placeholder') || 'Tapez et appuyez sur Entrée...';
    }, 1500);
}

function removeTag(button) {
    button.closest('.tag').remove();
}

// Toggle background fields
function toggleBackgroundFields(select) {
    const founderItem = select.closest('.founder-item');
    const educationFields = founderItem.querySelector('.education-fields');
    const professionalFields = founderItem.querySelector('.professional-fields');
    
    if (select.value === 'education') {
        educationFields.style.display = 'block';
        professionalFields.style.display = 'none';
    } else if (select.value === 'professional') {
        educationFields.style.display = 'none';
        professionalFields.style.display = 'block';
    } else {
        educationFields.style.display = 'none';
        professionalFields.style.display = 'none';
    }
}

// Add founder
let founderCounter = 1;
function addFounder() {
    const section = document.getElementById('founders-section');
    const founderId = founderCounter++;
    
    const div = document.createElement('div');
    div.className = 'founder-item';
    div.dataset.founderId = founderId;
    div.innerHTML = `
        <div class="grid-2">
            <div class="form-group">
                <label>Nom</label>
                <input type="text" name="founder_name">
            </div>
            <div class="form-group">
                <label>Titre</label>
                <input type="text" name="founder_title">
            </div>
        </div>
        
        <div class="form-group">
            <label>Type de background</label>
            <select name="background_type" onchange="toggleBackgroundFields(this)">
                <option value="">Sélectionner un type</option>
                <option value="education">Éducation</option>
                <option value="professional">Professionnel</option>
            </select>
        </div>
        
        <div class="education-fields" style="display: none;">
            <h4 style="color: #64b5f6;">Éducation</h4>
            <div class="grid-2">
                <div class="form-group">
                    <label>Institution</label>
                    <input type="text" name="education_institution">
                </div>
                <div class="form-group">
                    <label>Diplôme</label>
                    <input type="text" name="education_degree">
                </div>
            </div>
            
            <div class="form-group">
                <label>Écoles/Institutions</label>
                <div class="tag-container" data-category="education" data-founder-id="${founderId}">
                    <div class="tag-display" id="education-tags-${founderId}"></div>
                    <input type="text" class="tag-input" placeholder="Tapez une école et appuyez sur Entrée..." data-category="education" data-founder-id="${founderId}">
                </div>
            </div>
        </div>
        
        <div class="professional-fields" style="display: none;">
            <h4 style="color: #64b5f6;">Expérience Professionnelle</h4>
            <div class="grid-2">
                <div class="form-group">
                    <label>Entreprise</label>
                    <input type="text" name="professional_company">
                </div>
                <div class="form-group">
                    <label>Poste</label>
                    <input type="text" name="professional_position">
                </div>
            </div>
            
            <div class="form-group">
                <label>Entreprises précédentes</label>
                <div class="tag-container" data-category="professional" data-founder-id="${founderId}">
                    <div class="tag-display" id="professional-tags-${founderId}"></div>
                    <input type="text" class="tag-input" placeholder="Tapez une entreprise et appuyez sur Entrée..." data-category="professional" data-founder-id="${founderId}">
                </div>
            </div>
        </div>
        
        <button type="button" class="btn btn-danger" onclick="removeFounder(this)">Supprimer</button>
    `;
    
    section.appendChild(div);
    
    // Réattacher les événements aux nouveaux inputs
    div.querySelectorAll('.tag-input').forEach(input => {
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                
                const tagName = input.value.trim();
                if (tagName) {
                    addTag(input, tagName);
                    input.value = '';
                }
                return false;
            }
        });
    });
}

function removeFounder(btn) {
    btn.closest('.founder-item').remove();
}

// Add investor
function addInvestor() {
    const section = document.getElementById('investors-section');
    const div = document.createElement('div');
    div.className = 'investor-item';
    div.innerHTML = `
        <input type="text" name="investor_name" placeholder="Nom de l'investisseur">
        <button type="button" class="btn btn-danger" onclick="removeInvestor(this)">×</button>
    `;
    section.appendChild(div);
}

function removeInvestor(btn) {
    btn.closest('.investor-item').remove();
}

// Form submission
function setupFormSubmission() {
    document.getElementById('companyForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // Collect founders
        const founders = [];
        document.querySelectorAll('.founder-item').forEach((item, index) => {
            const name = item.querySelector('input[name="founder_name"]').value.trim();
            if (name) {
                const founder = {
                    name: name,
                    title: item.querySelector('input[name="founder_title"]').value.trim(),
                    background_type: item.querySelector('select[name="background_type"]').value,
                };
                
                if (founder.background_type === 'education') {
                    founder.education_background = {
                        institution: item.querySelector('input[name="education_institution"]').value.trim(),
                        degree: item.querySelector('input[name="education_degree"]').value.trim()
                    };
                    
                    // Collect education tags
                    const educationTags = [];
                    item.querySelectorAll('[data-category="education"] .tag').forEach(tag => {
                        educationTags.push(tag.dataset.tag);
                    });
                    founder.education_tags = educationTags;
                }
                
                if (founder.background_type === 'professional') {
                    founder.professional_background = {
                        company: item.querySelector('input[name="professional_company"]').value.trim(),
                        position: item.querySelector('input[name="professional_position"]').value.trim()
                    };
                    
                    // Collect professional tags
                    const professionalTags = [];
                    item.querySelectorAll('[data-category="professional"] .tag').forEach(tag => {
                        professionalTags.push(tag.dataset.tag);
                    });
                    founder.professional_tags = professionalTags;
                }
                
                founders.push(founder);
            }
        });
        
        // Collect investors
        const investors = [];
        document.querySelectorAll('input[name="investor_name"]').forEach(input => {
            const name = input.value.trim();
            if (name) investors.push(name);
        });
        
        // Collect company tags
        const secteurTags = [];
        document.querySelectorAll('[data-category="secteur"] .tag').forEach(tag => {
            secteurTags.push(tag.dataset.tag);
        });
        
        const coreBusinessTags = [];
        document.querySelectorAll('[data-category="core_business"] .tag').forEach(tag => {
            coreBusinessTags.push(tag.dataset.tag);
        });
        
        const data = {
            name: formData.get('name'),
            website: formData.get('website') || null,
            description: formData.get('description') || null,
            location: formData.get('location') || null,
            high_profile: parseInt(formData.get('high_profile')),
            remuneration: parseInt(formData.get('remuneration')),
            work_intensity: formData.get('work_intensity'),
            company_size: formData.get('company_size'),
            founded_year: formData.get('founded_year') ? parseInt(formData.get('founded_year')) : null,
            last_funding: formData.get('last_funding') || null,
            founders: founders,
            investors: investors,
            secteur_tags: secteurTags,
            core_business_tags: coreBusinessTags,
            relations: []
        };
        
        try {
            const url = {% if company %}'/api/companies/{{ company.id }}'{% else %}'/api/companies'{% endif %};
            const method = {% if company %}'PUT'{% else %}'POST'{% endif %};
            
            const response = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                window.location.href = '/';
            } else {
                const error = await response.json();
                alert('Erreur: ' + (error.detail || 'Erreur inconnue'));
            }
        } catch (error) {
            alert('Erreur réseau: ' + error.message);
        }
    });
}

{% if company %}
async function deleteCompany() {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette entreprise ?')) {
        try {
            const response = await fetch('/api/companies/{{ company.id }}', {method: 'DELETE'});
            if (response.ok) {
                window.location.href = '/';
            } else {
                alert('Erreur lors de la suppression');
            }
        } catch (error) {
            alert('Erreur réseau: ' + error.message);
        }
    }
}
{% endif %}
</script>

<style>
.tag-container {
    border: 1px solid rgba(100, 181, 246, 0.3);
    border-radius: 8px;
    background: rgba(30, 30, 46, 0.4);
    padding: 0.5rem;
    min-height: 60px;
}

.tag-display {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    min-height: 32px;
}

.tag {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    border-radius: 16px;
    font-size: 0.8rem;
    font-weight: 500;
}

.tag-remove {
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    padding: 0;
    margin-left: 0.25rem;
    font-size: 1rem;
    line-height: 1;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.tag-remove:hover {
    opacity: 1;
}

.tag-input {
    width: 100%;
    background: transparent;
    border: none;
    outline: none;
    color: #fff;
    font-size: 0.9rem;
    padding: 0.25rem 0;
}

.tag-input::placeholder {
    color: rgba(158, 158, 158, 0.7);
}

.founder-item {
    background: rgba(30, 30, 46, 0.6);
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.investor-item {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.5rem;
    align-items: center;
}

.investor-item input {
    flex: 1;
}
</style>
{% endblock %}