{% extends "base.html" %}

{% block title %}
{% if company %}Éditer {{ company.name }}{% else %}Nouvelle entreprise{% endif %} - Tech Companies Database
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h2 style="color: #64b5f6;">
        {% if company %}Éditer {{ company.name }}{% else %}Nouvelle entreprise{% endif %}
    </h2>
    <a href="{% if company %}/companies/{{ company.id }}{% else %}/{% endif %}" class="btn btn-secondary">← Annuler</a>
</div>

<form id="companyForm" method="post" action="{% if company %}/companies/{{ company.id }}/edit{% else %}/companies/new{% endif %}" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    <!-- Main Form -->
    <div>
        <div class="card">
            <h3 style="color: #64b5f6; margin-bottom: 1rem;">Informations de base</h3>
            
            <div class="grid-2">
                <div class="form-group">
                    <label for="name">Nom de l'entreprise *</label>
                    <input type="text" id="name" name="name" required 
                           value="{% if company %}{{ company.name }}{% endif %}">
                </div>
                <div class="form-group">
                    <label for="website">Site web</label>
                    <input type="url" id="website" name="website" 
                           value="{% if company %}{{ company.website or '' }}{% endif %}">
                </div>
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" rows="3">{% if company %}{{ company.description or '' }}{% endif %}</textarea>
            </div>

            <!-- SECTEUR TAGS -->
            <div class="form-group">
                <label>Secteur</label>
                <div class="tag-container" data-category="secteur">
                    <div class="tag-display" id="secteur-tags">
                        {% if company and company.get_secteur_tags() %}
                            {% for tag in company.get_secteur_tags() %}
                            <span class="tag" data-tag="{{ tag.name }}" style="background-color: {{ tag.color }}20; color: {{ tag.color }}; border: 1px solid {{ tag.color }}40;">
                                {{ tag.name }}
                                <button type="button" class="tag-remove" onclick="removeTag(this)">×</button>
                            </span>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <input type="text" class="tag-input" placeholder="Tapez un secteur et appuyez sur Entrée..." data-category="secteur" list="tag-secteur">
                    <div class="autocomplete-list" style="display:none;"></div>
                </div>
            </div>
            
            <!-- CORE BUSINESS TAGS -->
            <div class="form-group">
                <label>Core Business</label>
                <div class="tag-container" data-category="core_business">
                    <div class="tag-display" id="core_business-tags">
                        {% if company and company.get_core_business_tags() %}
                            {% for tag in company.get_core_business_tags() %}
                            <span class="tag" data-tag="{{ tag.name }}" style="background-color: {{ tag.color }}20; color: {{ tag.color }}; border: 1px solid {{ tag.color }}40;">
                                {{ tag.name }}
                                <button type="button" class="tag-remove" onclick="removeTag(this)">×</button>
                            </span>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <input type="text" class="tag-input" placeholder="Tapez un core business et appuyez sur Entrée..." data-category="core_business" list="tag-core_business">
                    <div class="autocomplete-list" style="display:none;"></div>
                </div>
            </div>

            <div class="form-group">
                <label for="location">Localisation</label>
                <input type="text" id="location" name="location" 
                       value="{% if company %}{{ company.location or '' }}{% endif %}">
            </div>
        </div>

        <div class="card">
            <h3 style="color: #64b5f6; margin-bottom: 1rem;">Critères personnalisés</h3>
            
            <div class="grid-4">
                <div class="form-group">
                    <label for="high_profile">Niveau de profil</label>
                    <select id="high_profile" name="high_profile">
                        <option value="5" {% if company and company.high_profile == 5 %}selected{% endif %}>High profile</option>
                        <option value="4" {% if company and company.high_profile == 4 %}selected{% endif %}>Above average profile</option>
                        <option value="3" {% if not company or company.high_profile == 3 %}selected{% endif %}>Average profile</option>
                        <option value="2" {% if company and company.high_profile == 2 %}selected{% endif %}>Easy of access</option>
                        <option value="1" {% if company and company.high_profile == 1 %}selected{% endif %}>Unlearning factory</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="remuneration">Rémunération</label>
                    <select id="remuneration" name="remuneration">
                        <option value="5" {% if company and company.remuneration == 5 %}selected{% endif %}>Overpaying</option>
                        <option value="4" {% if company and company.remuneration == 4 %}selected{% endif %}>Above Market</option>
                        <option value="3" {% if not company or company.remuneration == 3 %}selected{% endif %}>At Market</option>
                        <option value="2" {% if company and company.remuneration == 2 %}selected{% endif %}>Below Market</option>
                        <option value="1" {% if company and company.remuneration == 1 %}selected{% endif %}>Underpaying</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="work_intensity">Work Intensity</label>
                    <select id="work_intensity" name="work_intensity">
                        <option value="chill" {% if company and company.work_intensity == 'chill' %}selected{% endif %}>Chill</option>
                        <option value="balanced" {% if not company or company.work_intensity == 'balanced' %}selected{% endif %}>Balanced</option>
                        <option value="intense" {% if company and company.work_intensity == 'intense' %}selected{% endif %}>Intense</option>
                        <option value="bourrin" {% if company and company.work_intensity == 'bourrin' %}selected{% endif %}>Bourrin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="company_size">Taille</label>
                    <select id="company_size" name="company_size">
                        <option value="early" {% if company and company.company_size == 'early' %}selected{% endif %}>Early (0-10)</option>
                        <option value="startup" {% if not company or company.company_size == 'startup' %}selected{% endif %}>Startup (10-50)</option>
                        <option value="scaleup" {% if company and company.company_size == 'scaleup' %}selected{% endif %}>Scale-up (50-200)</option>
                        <option value="corp" {% if company and company.company_size == 'corp' %}selected{% endif %}>Corp (200+)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- FOUNDERS -->
        <div class="card">
            <h3 style="color: #64b5f6; margin-bottom: 1rem;">Founders</h3>
            <div id="founders-section">
                {% if company and company.founders %}
                    {% for founder in company.founders %}
                    <div class="founder-item" data-founder-id="{{ loop.index0 }}">
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Nom</label>
                                <div style="position: relative;">
                                    <input type="text" name="founder_name" value="{{ founder.name }}" oninput="onFounderInput(this)" autocomplete="off" list="person-suggestions">
                                    <input type="hidden" name="founder_person_id" value="{{ founder.person_id or '' }}">
                                    <div class="autocomplete-list" style="display:none;"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Titre</label>
                                <input type="text" name="founder_title" value="{{ founder.title or '' }}">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Background</label>
                            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" class="background-checkbox" data-type="education" {% if founder.background_type == 'education' or (founder.education_institution or founder.get_education_tags) %}checked{% endif %} onchange="toggleBackgroundFields(this)">
                                    Éducation
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" class="background-checkbox" data-type="professional" {% if founder.background_type == 'professional' or (founder.professional_company or founder.get_professional_tags) %}checked{% endif %} onchange="toggleBackgroundFields(this)">
                                    Professionnel
                                </label>
                            </div>
                        </div>
                        
                        <!-- Education Background -->
                        <div class="education-fields" style="display: {% if founder.background_type == 'education' or (founder.education_institution or founder.get_education_tags) %}block{% else %}none{% endif %};">
                            <h4 style="color: #64b5f6;">Éducation</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Institution</label>
                                    <input type="text" name="education_institution" value="{{ founder.education_institution or '' }}">
                                </div>
                                <div class="form-group">
                                    <label>Diplôme</label>
                                    <input type="text" name="education_degree" value="{{ founder.education_degree or '' }}">
                                </div>
                            </div>
                            
                            <!-- EDUCATION TAGS -->
                            <div class="form-group">
                                <label>Écoles/Institutions</label>
                                <div class="tag-container" data-category="education" data-founder-id="{{ loop.index0 }}">
                                    <div class="tag-display" id="education-tags-{{ loop.index0 }}">
                                        {% if founder.get_education_tags %}
                                            {% for tag in founder.get_education_tags() %}
                                            <span class="tag" data-tag="{{ tag.name }}" style="background-color: {{ tag.color }}20; color: {{ tag.color }}; border: 1px solid {{ tag.color }}40;">
                                                {{ tag.name }}
                                                <button type="button" class="tag-remove" onclick="removeTag(this)">×</button>
                                            </span>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    <input type="text" class="tag-input" placeholder="Tapez une école et appuyez sur Entrée..." data-category="education" data-founder-id="{{ loop.index0 }}" list="tag-education">
                                    <div class="autocomplete-list" style="display:none;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Professional Background -->
                        <div class="professional-fields" style="display: {% if founder.background_type == 'professional' or (founder.professional_company or founder.get_professional_tags) %}block{% else %}none{% endif %};">
                            <h4 style="color: #64b5f6;">Expérience Professionnelle</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Entreprise</label>
                                    <input type="text" name="professional_company" value="{{ founder.professional_company or '' }}">
                                </div>
                                <div class="form-group">
                                    <label>Poste</label>
                                    <input type="text" name="professional_position" value="{{ founder.professional_position or '' }}">
                                </div>
                            </div>
                            
                            <!-- PROFESSIONAL TAGS -->
                            <div class="form-group">
                                <label>Entreprises précédentes</label>
                                <div class="tag-container" data-category="professional" data-founder-id="{{ loop.index0 }}">
                                    <div class="tag-display" id="professional-tags-{{ loop.index0 }}">
                                        {% if founder.get_professional_tags %}
                                            {% for tag in founder.get_professional_tags() %}
                                            <span class="tag" data-tag="{{ tag.name }}" style="background-color: {{ tag.color }}20; color: {{ tag.color }}; border: 1px solid {{ tag.color }}40;">
                                                {{ tag.name }}
                                                <button type="button" class="tag-remove" onclick="removeTag(this)">×</button>
                                            </span>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    <input type="text" class="tag-input" placeholder="Tapez une entreprise et appuyez sur Entrée..." data-category="professional" data-founder-id="{{ loop.index0 }}" list="tag-professional">
                                    <div class="autocomplete-list" style="display:none;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-danger" onclick="removeFounder(this)">Supprimer</button>
                    </div>
                    {% endfor %}
                {% else %}
                    <!-- Default founder -->
                    <div class="founder-item" data-founder-id="0">
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Nom</label>
                                <div style="position: relative;">
                                    <input type="text" name="founder_name" oninput="onFounderInput(this)" autocomplete="off" list="person-suggestions">
                                    <input type="hidden" name="founder_person_id" value="">
                                    <div class="autocomplete-list" style="display:none;"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Titre</label>
                                <input type="text" name="founder_title">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Background</label>
                            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" class="background-checkbox" data-type="education" onchange="toggleBackgroundFields(this)">
                                    Éducation
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" class="background-checkbox" data-type="professional" onchange="toggleBackgroundFields(this)">
                                    Professionnel
                                </label>
                            </div>
                        </div>
                        
                        <!-- Education Background -->
                        <div class="education-fields" style="display: none;">
                            <h4 style="color: #64b5f6;">Éducation</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Institution</label>
                                    <input type="text" name="education_institution">
                                </div>
                                <div class="form-group">
                                    <label>Diplôme</label>
                                    <input type="text" name="education_degree">
                                </div>
                            </div>
                            
                            <!-- EDUCATION TAGS -->
                            <div class="form-group">
                                <label>Écoles/Institutions</label>
                                <div class="tag-container" data-category="education" data-founder-id="0">
                                    <div class="tag-display" id="education-tags-0"></div>
                                    <input type="text" class="tag-input" placeholder="Tapez une école et appuyez sur Entrée..." data-category="education" data-founder-id="0" list="tag-education">
                                    <div class="autocomplete-list" style="display:none;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Professional Background -->
                        <div class="professional-fields" style="display: none;">
                            <h4 style="color: #64b5f6;">Expérience Professionnelle</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Entreprise</label>
                                    <input type="text" name="professional_company">
                                </div>
                                <div class="form-group">
                                    <label>Poste</label>
                                    <input type="text" name="professional_position">
                                </div>
                            </div>
                            
                            <!-- PROFESSIONAL TAGS -->
                            <div class="form-group">
                                <label>Entreprises précédentes</label>
                                <div class="tag-container" data-category="professional" data-founder-id="0">
                                    <div class="tag-display" id="professional-tags-0"></div>
                                    <input type="text" class="tag-input" placeholder="Tapez une entreprise et appuyez sur Entrée..." data-category="professional" data-founder-id="0" list="tag-professional">
                                    <div class="autocomplete-list" style="display:none;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-danger" onclick="removeFounder(this)">Supprimer</button>
                    </div>
                {% endif %}
            </div>
            <button type="button" class="btn btn-secondary" onclick="addFounder()">+ Ajouter founder</button>
        </div>

        <!-- EMPLOYÉS -->
        <div class="card">
            <h3 style="color: #64b5f6; margin-bottom: 1rem;">Employés</h3>
            <div id="employees-section"></div>
            <button type="button" class="btn btn-secondary" onclick="addEmployee()">+ Ajouter employé</button>
        </div>

        <!-- INVESTORS -->
        <div class="card">
            <h3 style="color: #64b5f6; margin-bottom: 1rem;">Investisseurs</h3>
            <div id="investors-section">
                {% if company and company.investors %}
                    {% for investor in company.investors %}
                    <div class="investor-item">
                        <input type="text" name="investor_name" value="{{ investor.name }}">
                        <button type="button" class="btn btn-danger" onclick="removeInvestor(this)">×</button>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="investor-item">
                        <input type="text" name="investor_name" placeholder="Nom de l'investisseur">
                        <button type="button" class="btn btn-danger" onclick="removeInvestor(this)">×</button>
                    </div>
                {% endif %}
            </div>
            <button type="button" class="btn btn-secondary" onclick="addInvestor()">+ Ajouter investisseur</button>
        </div>
    </div>

    <!-- Sidebar -->
    <div>
        <div class="card">
            <h3 style="color: #64b5f6; margin-bottom: 1rem;">Données financières</h3>
            
            <div class="form-group">
                <label for="founded_year">Année de création</label>
                <input type="number" id="founded_year" name="founded_year" min="1900" max="2030"
                       value="{% if company %}{{ company.founded_year or '' }}{% endif %}">
            </div>
            
            <div class="form-group">
                <label for="last_funding">Dernier funding</label>
                <input type="text" id="last_funding" name="last_funding" 
                       placeholder="ex: $30M Series A"
                       value="{% if company %}{{ company.last_funding or '' }}{% endif %}">
            </div>
        </div>

        <div style="display: flex; gap: 1rem;">
            <button type="submit" class="btn btn-primary" style="flex: 1;">
                {% if company %}Mettre à jour{% else %}Créer{% endif %}
            </button>
            {% if company %}
            <button type="button" class="btn btn-danger" onclick="deleteCompany()">
                Supprimer
            </button>
            {% endif %}
        </div>
    </div>
</form>

<script>
// SYSTÈME DE TAGS SIMPLIFIÉ ET FONCTIONNEL
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Initializing tag system...');
    initializeTagSystem();
    setupFormSubmission();
});

function initializeTagSystem() {
    // Attacher les événements à TOUS les inputs de tags
    document.querySelectorAll('.tag-input').forEach(input => {
        console.log(`Attaching events to input: ${input.dataset.category}`, input.dataset.founderId ? `founder-${input.dataset.founderId}` : 'company');
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                
                const tagName = input.value.trim();
                if (tagName) {
                    console.log(`Adding tag: "${tagName}" to ${input.dataset.category}`);
                    addTag(input, tagName);
                    input.value = '';
                }
                return false;
            }
        });
    });
    
    const remunerationLabels = {1: 'Underpaying', 2: 'Below Market', 3: 'At Market', 4: 'Above Market', 5: 'Overpaying'};
    setupFounderAutocomplete();
    setupTagAutocomplete();
    preloadPersonAndTagSuggestions();
}
// Preload initial suggestions into local datastores to make the UI immediately show options
let preloadCache = { persons: [], tags: { secteur: [], core_business: [], education: [], professional: [] } };
async function preloadPersonAndTagSuggestions() {
    try {
        const [personsResp, secteurResp, coreResp, eduResp, proResp] = await Promise.all([
            fetch('/api/persons'),
            fetch('/api/tags?category=secteur&limit=100'),
            fetch('/api/tags?category=core_business&limit=100'),
            fetch('/api/tags?category=education&limit=100'),
            fetch('/api/tags?category=professional&limit=100')
        ]);
        preloadCache.persons = await personsResp.json();
        preloadCache.tags.secteur = await secteurResp.json();
        preloadCache.tags.core_business = await coreResp.json();
        preloadCache.tags.education = await eduResp.json();
        preloadCache.tags.professional = await proResp.json();

        // Populate datalists for native autocomplete hints
        const personList = document.getElementById('person-suggestions');
        personList.innerHTML = '';
        preloadCache.persons.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.name;
            personList.appendChild(opt);
        });

        const map = [
            ['tag-secteur', preloadCache.tags.secteur],
            ['tag-core_business', preloadCache.tags.core_business],
            ['tag-education', preloadCache.tags.education],
            ['tag-professional', preloadCache.tags.professional]
        ];
        map.forEach(([id, arr]) => {
            const dl = document.getElementById(id);
            if (!dl) return;
            dl.innerHTML = '';
            arr.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.name;
                dl.appendChild(opt);
            });
        });
        // Show simple inline hint for founders if we have persons
        document.querySelectorAll('input[name="founder_name"]').forEach(inp => {
            if (preloadCache.persons.length > 0 && !inp.placeholder.includes('ex:')) {
                const example = preloadCache.persons[0]?.name || '';
                if (example) inp.placeholder = `Tapez un nom (ex: ${example})`;
            }
        });
    } catch (e) {
        // ignore if preload fails
    }
}

function addTag(input, tagName) {
    const container = input.closest('.tag-container');
    const category = input.dataset.category;
    const founderId = input.dataset.founderId;
    
    // Trouver le tag display
    const tagDisplay = container.querySelector('.tag-display');
    
    // Vérifier si le tag existe déjà
    const existingTags = Array.from(tagDisplay.querySelectorAll('.tag')).map(tag => tag.dataset.tag);
    if (existingTags.includes(tagName)) {
        console.log(`Tag "${tagName}" already exists`);
        input.placeholder = `"${tagName}" existe déjà!`;
        setTimeout(() => {
            input.placeholder = input.getAttribute('placeholder') || 'Tapez et appuyez sur Entrée...';
        }, 2000);
        return;
    }
    
    // Créer le tag
    const tagElement = document.createElement('span');
    tagElement.className = 'tag';
    tagElement.dataset.tag = tagName;
    tagElement.style.cssText = 'background-color: #64b5f620; color: #64b5f6; border: 1px solid #64b5f640; padding: 0.25rem 0.75rem; border-radius: 16px; font-size: 0.8rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem; margin-right: 0.5rem; margin-bottom: 0.5rem;';
    tagElement.innerHTML = `
        ${tagName}
        <button type="button" class="tag-remove" onclick="removeTag(this)" style="background: none; border: none; color: inherit; cursor: pointer; padding: 0; margin-left: 0.25rem; font-size: 1rem; line-height: 1; opacity: 0.7;">×</button>
    `;
    
    tagDisplay.appendChild(tagElement);
    console.log(`✅ Added tag "${tagName}" to ${category}${founderId ? ` for founder ${founderId}` : ''}`);
    
    // Feedback visuel
    input.placeholder = `✅ "${tagName}" ajouté!`;
    setTimeout(() => {
        input.placeholder = input.getAttribute('placeholder') || 'Tapez et appuyez sur Entrée...';
    }, 1500);
}

function removeTag(button) {
    button.closest('.tag').remove();
}

// --- Autocomplete for founders (Person) ---
let founderSearchDebounce;
function setupFounderAutocomplete() {
    document.querySelectorAll('input[name="founder_name"]').forEach(input => {
        input.addEventListener('focus', () => onFounderInput(input));
    });
    document.addEventListener('click', (e) => {
        document.querySelectorAll('.autocomplete-list').forEach(list => {
            if (!list.contains(e.target) && list.previousElementSibling !== e.target) {
                list.style.display = 'none';
                const card = list.closest('.card');
                if (card) card.style.zIndex = '';
            }
        });
    });
}

function onFounderInput(inputEl) {
    // Clear selected person when typing
    const hidden = inputEl.parentElement.querySelector('input[name="founder_person_id"]');
    if (hidden) hidden.value = '';
    const q = inputEl.value.trim();
    const list = inputEl.parentElement.querySelector('.autocomplete-list');
    if (!q) {
        // Show preload suggestions or fetch top persons
        const useItems = (preloadCache.persons || []).slice(0, 8).map(p => ({ label: p.name, value: p.id }));
        if (useItems.length > 0) {
            renderAutocompleteList(list, useItems, (item) => {
                inputEl.value = item.label;
                if (hidden) hidden.value = item.value;
                list.style.display = 'none';
                const c = list.closest('.card');
                if (c) c.style.zIndex = '';
            });
            return;
        }
        // Fallback: fetch top persons
        fetch('/api/persons')
            .then(r => r.json())
            .then(arr => {
                renderAutocompleteList(list, (arr || []).slice(0, 8).map(p => ({ label: p.name, value: p.id })), (item) => {
                    inputEl.value = item.label;
                    if (hidden) hidden.value = item.value;
                    list.style.display = 'none';
                    const c = list.closest('.card');
                    if (c) c.style.zIndex = '';
                });
            })
            .catch(() => { if (list) list.style.display = 'none'; });
        return;
    }
    clearTimeout(founderSearchDebounce);
    founderSearchDebounce = setTimeout(async () => {
        try {
            const resp = await fetch(`/api/persons/search?q=${encodeURIComponent(q)}&limit=8`);
            const results = await resp.json();
            renderAutocompleteList(list, results.map(r => ({ label: r.name, value: r.id })), (item) => {
                inputEl.value = item.label;
                if (hidden) hidden.value = item.value;
                list.style.display = 'none';
                const c = list.closest('.card');
                if (c) c.style.zIndex = '';
            });
        } catch (e) {
            // ignore
        }
    }, 150);
}

function renderAutocompleteList(listEl, items, onClick) {
    if (!listEl) return;
    listEl.innerHTML = '';
    if (!items || items.length === 0) {
        listEl.style.display = 'none';
        const c = listEl.closest('.card');
        if (c) c.style.zIndex = '';
        return;
    }
    items.forEach(it => {
        const div = document.createElement('div');
        div.className = 'autocomplete-item';
        div.textContent = it.label;
        div.addEventListener('click', () => onClick(it));
        listEl.appendChild(div);
    });
    listEl.style.display = 'block';
    const c = listEl.closest('.card');
    if (c) c.style.zIndex = '1000';
}

// --- Autocomplete for tags ---
let tagSearchDebounce;
function setupTagAutocomplete() {
    document.querySelectorAll('.tag-input').forEach(input => {
        input.addEventListener('input', () => onTagInput(input));
        input.addEventListener('focus', () => onTagInput(input));
    });
}

function onTagInput(input) {
    const q = input.value.trim();
    const list = input.parentElement.querySelector('.autocomplete-list');
    const category = input.dataset.category;
    if (!q) {
        // Show preload tags by category
        const preload = (preloadCache.tags && preloadCache.tags[category]) ? preloadCache.tags[category] : [];
        if (preload.length > 0) {
            renderAutocompleteList(list, preload.slice(0, 8).map(t => ({ label: t.name, value: t.name })), (item) => {
                addTag(input, item.label);
                input.value = '';
                list.style.display = 'none';
                const c = list.closest('.card');
                if (c) c.style.zIndex = '';
            });
            return;
        }
        // Fallback: fetch top tags
        fetch(`/api/tags?category=${encodeURIComponent(category)}&limit=20`)
            .then(r => r.json())
            .then(arr => {
                renderAutocompleteList(list, (arr || []).slice(0, 8).map(t => ({ label: t.name, value: t.name })), (item) => {
                    addTag(input, item.label);
                    input.value = '';
                    list.style.display = 'none';
                    const c = list.closest('.card');
                    if (c) c.style.zIndex = '';
                });
            })
            .catch(() => { if (list) list.style.display = 'none'; });
        return;
    }
    clearTimeout(tagSearchDebounce);
    tagSearchDebounce = setTimeout(async () => {
        try {
            const resp = await fetch(`/api/tags/search?q=${encodeURIComponent(q)}&category=${encodeURIComponent(category)}&limit=8`);
            const results = await resp.json();
            renderAutocompleteList(list, results.map(r => ({ label: r.name, value: r.name })), (item) => {
                addTag(input, item.label);
                input.value = '';
                list.style.display = 'none';
                const c = list.closest('.card');
                if (c) c.style.zIndex = '';
            });
        } catch (e) {
            // ignore
        }
    }, 150);
}

// Toggle background fields
function toggleBackgroundFields(checkbox) {
    const container = checkbox.closest('.founder-item, [data-employee-id]');
    if (!container) return;
    const educationFields = container.querySelector('.education-fields');
    const professionalFields = container.querySelector('.professional-fields');
    const type = checkbox.dataset.type;
    
    if (type === 'education') {
        educationFields.style.display = checkbox.checked ? 'block' : 'none';
    } else if (type === 'professional') {
        professionalFields.style.display = checkbox.checked ? 'block' : 'none';
    }
}

// Add founder
let founderCounter = 1;
function addFounder() {
    const section = document.getElementById('founders-section');
    const founderId = founderCounter++;
    
    const div = document.createElement('div');
    div.className = 'employee-item';
    div.dataset.founderId = founderId;
    div.innerHTML = `
        <div class="grid-2">
            <div class="form-group">
                <label>Nom</label>
                <div style="position: relative;">
                    <input type="text" name="founder_name" oninput="onFounderInput(this)" autocomplete="off">
                    <input type="hidden" name="founder_person_id" value="">
                    <div class="autocomplete-list" style="display:none;"></div>
                </div>
            </div>
            <div class="form-group">
                <label>Titre</label>
                <input type="text" name="founder_title">
            </div>
        </div>
        
        <div class="form-group">
            <label>Background</label>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" class="background-checkbox" data-type="education" onchange="toggleBackgroundFields(this)">
                    Éducation
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" class="background-checkbox" data-type="professional" onchange="toggleBackgroundFields(this)">
                    Professionnel
                </label>
            </div>
        </div>
        
        <div class="education-fields" style="display: none;">
            <h4 style="color: #64b5f6;">Éducation</h4>
            <div class="grid-2">
                <div class="form-group">
                    <label>Institution</label>
                    <input type="text" name="education_institution">
                </div>
                <div class="form-group">
                    <label>Diplôme</label>
                    <input type="text" name="education_degree">
                </div>
            </div>
            
            <div class="form-group">
                <label>Écoles/Institutions</label>
                <div class="tag-container" data-category="education" data-founder-id="${founderId}">
                    <div class="tag-display" id="education-tags-${founderId}"></div>
                    <input type="text" class="tag-input" placeholder="Tapez une école et appuyez sur Entrée..." data-category="education" data-founder-id="${founderId}">
                    <div class="autocomplete-list" style="display:none;"></div>
                </div>
            </div>
        </div>
        
        <div class="professional-fields" style="display: none;">
            <h4 style="color: #64b5f6;">Expérience Professionnelle</h4>
            <div class="grid-2">
                <div class="form-group">
                    <label>Entreprise</label>
                    <input type="text" name="professional_company">
                </div>
                <div class="form-group">
                    <label>Poste</label>
                    <input type="text" name="professional_position">
                </div>
            </div>
            
            <div class="form-group">
                <label>Entreprises précédentes</label>
                <div class="tag-container" data-category="professional" data-founder-id="${founderId}">
                    <div class="tag-display" id="professional-tags-${founderId}"></div>
                    <input type="text" class="tag-input" placeholder="Tapez une entreprise et appuyez sur Entrée..." data-category="professional" data-founder-id="${founderId}">
                    <div class="autocomplete-list" style="display:none;"></div>
                </div>
            </div>
        </div>
        
        <button type="button" class="btn btn-danger" onclick="removeFounder(this)">Supprimer</button>
    `;
    
    section.appendChild(div);
    
    // Réattacher les événements aux nouveaux inputs
    div.querySelectorAll('.tag-input').forEach(input => {
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                
                const tagName = input.value.trim();
                if (tagName) {
                    addTag(input, tagName);
                    input.value = '';
                }
                return false;
            }
        });
        input.addEventListener('input', () => onTagInput(input));
        input.addEventListener('focus', () => onTagInput(input));
    });
    // Brancher l'autocomplétion du nom de founder
    const founderNameInput = div.querySelector('input[name="founder_name"]');
    if (founderNameInput) founderNameInput.addEventListener('focus', () => onFounderInput(founderNameInput));
}

// Employees UI (similar to founders, simplified)
let employeeCounter = 0;
function addEmployee(prefill) {
    const section = document.getElementById('employees-section');
    const employeeId = employeeCounter++;
    const div = document.createElement('div');
    div.className = 'founder-item';
    div.dataset.employeeId = employeeId;
    div.innerHTML = `
        <div class="grid-2">
            <div class="form-group">
                <label>Nom</label>
                <div style="position: relative;">
                    <input type="text" name="employee_name" oninput="onEmployeeInput(this)" autocomplete="off">
                    <input type="hidden" name="employee_person_id" value="">
                    <div class="autocomplete-list" style="display:none;"></div>
                </div>
            </div>
            <div class="form-group">
                <label>Titre</label>
                <input type="text" name="employee_title">
            </div>
        </div>
        <div class="grid-3">
            <div class="form-group">
                <label>Rôle</label>
                <input type="text" name="employee_role" placeholder="ex: Staff Engineer, Product Manager">
            </div>
            <div class="form-group">
                <label>Département</label>
                <input type="text" name="employee_department" placeholder="ex: Engineering, Product, Sales">
            </div>
            <div class="form-group">
                <label>Parcours</label>
                <select name="employee_career_track">
                    <option value="">(non précisé)</option>
                    <option value="IC">IC</option>
                    <option value="management">Management</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>Background</label>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" class="background-checkbox" data-type="education" onchange="toggleBackgroundFields(this)">
                    Éducation
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" class="background-checkbox" data-type="professional" onchange="toggleBackgroundFields(this)">
                    Professionnel
                </label>
            </div>
        </div>
        <div class="education-fields" style="display: none;">
            <h4 style="color: #64b5f6;">Éducation</h4>
            <div class="grid-2">
                <div class="form-group">
                    <label>Institution</label>
                    <input type="text" name="employee_education_institution">
                </div>
                <div class="form-group">
                    <label>Diplôme</label>
                    <input type="text" name="employee_education_degree">
                </div>
            </div>
            <div class="form-group">
                <label>Écoles/Institutions</label>
                <div class="tag-container" data-category="education" data-employee-id="${employeeId}">
                    <div class="tag-display" id="emp-education-tags-${employeeId}"></div>
                    <input type="text" class="tag-input" placeholder="Tapez une école et appuyez sur Entrée..." data-category="education" data-employee-id="${employeeId}">
                    <div class="autocomplete-list" style="display:none;"></div>
                </div>
            </div>
        </div>
        <div class="professional-fields" style="display: none;">
            <h4 style="color: #64b5f6;">Expérience Professionnelle</h4>
            <div class="grid-2">
                <div class="form-group">
                    <label>Entreprise</label>
                    <input type="text" name="employee_professional_company">
                </div>
                <div class="form-group">
                    <label>Poste</label>
                    <input type="text" name="employee_professional_position">
                </div>
            </div>
            <div class="form-group">
                <label>Entreprises précédentes</label>
                <div class="tag-container" data-category="professional" data-employee-id="${employeeId}">
                    <div class="tag-display" id="emp-professional-tags-${employeeId}"></div>
                    <input type="text" class="tag-input" placeholder="Tapez une entreprise et appuyez sur Entrée..." data-category="professional" data-employee-id="${employeeId}">
                    <div class="autocomplete-list" style="display:none;"></div>
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-danger" onclick="removeEmployee(this)">Supprimer</button>
    `;
    section.appendChild(div);
    // Hook events
    div.querySelectorAll('.tag-input').forEach(input => {
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                const tagName = input.value.trim();
                if (tagName) {
                    addTag(input, tagName);
                    input.value = '';
                }
                return false;
            }
        });
        input.addEventListener('input', () => onTagInput(input));
        input.addEventListener('focus', () => onTagInput(input));
    });
}

function removeEmployee(btn) {
    const el = btn.closest('.employee-item');
    if (el) el.remove();
}

let employeeSearchDebounce;
function onEmployeeInput(inputEl) {
    const hidden = inputEl.parentElement.querySelector('input[name="employee_person_id"]');
    if (hidden) hidden.value = '';
    const q = inputEl.value.trim();
    const list = inputEl.parentElement.querySelector('.autocomplete-list');
    if (!q) {
        const useItems = (preloadCache.persons || []).slice(0, 8).map(p => ({ label: p.name, value: p.id }));
        if (useItems.length > 0) {
            renderAutocompleteList(list, useItems, (item) => {
                inputEl.value = item.label;
                if (hidden) hidden.value = item.value;
                list.style.display = 'none';
                const c = list.closest('.card');
                if (c) c.style.zIndex = '';
            });
            return;
        }
        fetch('/api/persons')
            .then(r => r.json())
            .then(arr => {
                renderAutocompleteList(list, (arr || []).slice(0, 8).map(p => ({ label: p.name, value: p.id })), (item) => {
                    inputEl.value = item.label;
                    if (hidden) hidden.value = item.value;
                    list.style.display = 'none';
                    const c = list.closest('.card');
                    if (c) c.style.zIndex = '';
                });
            })
            .catch(() => { if (list) list.style.display = 'none'; });
        return;
    }
    clearTimeout(employeeSearchDebounce);
    employeeSearchDebounce = setTimeout(async () => {
        try {
            const resp = await fetch(`/api/persons/search?q=${encodeURIComponent(q)}&limit=8`);
            const results = await resp.json();
            renderAutocompleteList(list, results.map(r => ({ label: r.name, value: r.id })), (item) => {
                inputEl.value = item.label;
                if (hidden) hidden.value = item.value;
                list.style.display = 'none';
                const c = list.closest('.card');
                if (c) c.style.zIndex = '';
            });
        } catch (e) {}
    }, 150);
}

function removeFounder(btn) {
    btn.closest('.founder-item').remove();
}

// Add investor
function addInvestor() {
    const section = document.getElementById('investors-section');
    const div = document.createElement('div');
    div.className = 'investor-item';
    div.innerHTML = `
        <input type="text" name="investor_name" placeholder="Nom de l'investisseur">
        <button type="button" class="btn btn-danger" onclick="removeInvestor(this)">×</button>
    `;
    section.appendChild(div);
}

function removeInvestor(btn) {
    btn.closest('.investor-item').remove();
}

// Form submission
function setupFormSubmission() {
    document.getElementById('companyForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // Collect founders
        const founders = [];
        document.querySelectorAll('.founder-item[data-founder-id]').forEach((item, index) => {
            const name = item.querySelector('input[name="founder_name"]').value.trim();
            if (name) {
                const founder = {
                    name: name,
                    title: item.querySelector('input[name="founder_title"]').value.trim(),
                };
                const personIdVal = item.querySelector('input[name="founder_person_id"]').value.trim();
                if (personIdVal) founder.person_id = parseInt(personIdVal, 10);
                
                // Check if education background is enabled
                const educationCheckbox = item.querySelector('.background-checkbox[data-type="education"]');
                if (educationCheckbox && educationCheckbox.checked) {
                    founder.background_type = 'education'; // Keep for compatibility
                    founder.education_background = {
                        institution: item.querySelector('input[name="education_institution"]').value.trim(),
                        degree: item.querySelector('input[name="education_degree"]').value.trim()
                    };
                    
                    // Collect education tags
                    const educationTags = [];
                    item.querySelectorAll('[data-category="education"] .tag').forEach(tag => {
                        educationTags.push(tag.dataset.tag);
                    });
                    founder.education_tags = educationTags;
                }
                
                // Check if professional background is enabled
                const professionalCheckbox = item.querySelector('.background-checkbox[data-type="professional"]');
                if (professionalCheckbox && professionalCheckbox.checked) {
                    if (!founder.background_type) founder.background_type = 'professional'; // Keep for compatibility
                    founder.professional_background = {
                        company: item.querySelector('input[name="professional_company"]').value.trim(),
                        position: item.querySelector('input[name="professional_position"]').value.trim()
                    };
                    
                    // Collect professional tags
                    const professionalTags = [];
                    item.querySelectorAll('[data-category="professional"] .tag').forEach(tag => {
                        professionalTags.push(tag.dataset.tag);
                    });
                    founder.professional_tags = professionalTags;
                }
                
                founders.push(founder);
            }
        });
        
        // Collect investors
        const investors = [];
        document.querySelectorAll('input[name="investor_name"]').forEach(input => {
            const name = input.value.trim();
            if (name) investors.push(name);
        });
        
        // Collect employees (null-safe)
        const employees = [];
        document.querySelectorAll('[data-employee-id]').forEach((item) => {
            const nameEl = item.querySelector('input[name="employee_name"]');
            const name = nameEl ? nameEl.value.trim() : '';
            if (!name) return;
            const titleEl = item.querySelector('input[name="employee_title"]');
            const emp = {
                name: name,
                title: titleEl ? titleEl.value.trim() : ''
            };
            const roleEl = item.querySelector('input[name="employee_role"]');
            if (roleEl && roleEl.value.trim()) emp.role = roleEl.value.trim();
            const depEl = item.querySelector('input[name="employee_department"]');
            if (depEl && depEl.value.trim()) emp.department = depEl.value.trim();
            const trackEl = item.querySelector('select[name="employee_career_track"]');
            if (trackEl && trackEl.value) emp.career_track = trackEl.value;

            const pidEl = item.querySelector('input[name="employee_person_id"]');
            const pid = pidEl ? pidEl.value.trim() : '';
            if (pid) emp.person_id = parseInt(pid, 10);

            const eduCheckbox = item.querySelector('.background-checkbox[data-type="education"]');
            const eduOn = !!(eduCheckbox && eduCheckbox.checked);
            if (eduOn) {
                emp.background_type = 'education';
                const instEl = item.querySelector('input[name="employee_education_institution"]');
                const degreeEl = item.querySelector('input[name="employee_education_degree"]');
                emp.education_background = {
                    institution: instEl ? instEl.value.trim() : '',
                    degree: degreeEl ? degreeEl.value.trim() : ''
                };
                const edTags = [];
                item.querySelectorAll('[data-category="education"] .tag').forEach(t => edTags.push(t.dataset.tag));
                emp.education_tags = edTags;
            }
            const proCheckbox = item.querySelector('.background-checkbox[data-type="professional"]');
            const proOn = !!(proCheckbox && proCheckbox.checked);
            if (proOn) {
                if (!emp.background_type) emp.background_type = 'professional';
                const compEl = item.querySelector('input[name="employee_professional_company"]');
                const posEl = item.querySelector('input[name="employee_professional_position"]');
                emp.professional_background = {
                    company: compEl ? compEl.value.trim() : '',
                    position: posEl ? posEl.value.trim() : ''
                };
                const prTags = [];
                item.querySelectorAll('[data-category="professional"] .tag').forEach(t => prTags.push(t.dataset.tag));
                emp.professional_tags = prTags;
            }
            employees.push(emp);
        });
        
        // Collect company tags
        const secteurTags = [];
        document.querySelectorAll('[data-category="secteur"] .tag').forEach(tag => {
            secteurTags.push(tag.dataset.tag);
        });
        
        const coreBusinessTags = [];
        document.querySelectorAll('[data-category="core_business"] .tag').forEach(tag => {
            coreBusinessTags.push(tag.dataset.tag);
        });
        
        const data = {
            name: formData.get('name'),
            website: formData.get('website') || null,
            description: formData.get('description') || null,
            location: formData.get('location') || null,
            high_profile: parseInt(formData.get('high_profile')),
            remuneration: parseInt(formData.get('remuneration')),
            work_intensity: formData.get('work_intensity'),
            company_size: formData.get('company_size'),
            founded_year: formData.get('founded_year') ? parseInt(formData.get('founded_year')) : null,
            last_funding: formData.get('last_funding') || null,
            founders: founders,
            employees: employees,
            investors: investors,
            secteur_tags: secteurTags,
            core_business_tags: coreBusinessTags,
            relations: []
        };
        
        try {
            const url = {% if company %}'/api/companies/{{ company.id }}'{% else %}'/api/companies'{% endif %};
            const method = {% if company %}'PUT'{% else %}'POST'{% endif %};
            
            const response = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                window.location.href = '/';
            } else {
                const error = await response.json();
                alert('Erreur: ' + (error.detail || 'Erreur inconnue'));
            }
        } catch (error) {
            alert('Erreur réseau: ' + error.message);
        }
    });
}

{% if company %}
async function deleteCompany() {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette entreprise ?')) {
        try {
            const response = await fetch('/api/companies/{{ company.id }}', {method: 'DELETE'});
            if (response.ok) {
                window.location.href = '/';
            } else {
                alert('Erreur lors de la suppression');
            }
        } catch (error) {
            alert('Erreur réseau: ' + error.message);
        }
    }
}
{% endif %}
</script>

<!-- Predeclared datalists for native HTML autocomplete hints -->
<datalist id="person-suggestions"></datalist>
<datalist id="tag-secteur"></datalist>
<datalist id="tag-core_business"></datalist>
<datalist id="tag-education"></datalist>
<datalist id="tag-professional"></datalist>

<style>
.autocomplete-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: rgba(30, 30, 46, 0.95);
    border: 1px solid rgba(100, 181, 246, 0.3);
    border-radius: 6px;
    z-index: 10;
    max-height: 220px;
    overflow: auto;
}
.autocomplete-item {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
}
.autocomplete-item:hover {
    background: rgba(100, 181, 246, 0.15);
}
.tag-container {
    border: 1px solid rgba(100, 181, 246, 0.3);
    border-radius: 8px;
    background: rgba(30, 30, 46, 0.4);
    padding: 0.5rem;
    min-height: 60px;
    position: relative;
    overflow: visible;
}

.tag-display {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    min-height: 32px;
}

.tag {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    border-radius: 16px;
    font-size: 0.8rem;
    font-weight: 500;
}

.tag-remove {
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    padding: 0;
    margin-left: 0.25rem;
    font-size: 1rem;
    line-height: 1;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.tag-remove:hover {
    opacity: 1;
}

.tag-input {
    width: 100%;
    background: transparent;
    border: none;
    outline: none;
    color: #fff;
    font-size: 0.9rem;
    padding: 0.25rem 0;
}

.tag-input::placeholder {
    color: rgba(158, 158, 158, 0.7);
}

.founder-item {
    background: rgba(30, 30, 46, 0.6);
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.investor-item {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.5rem;
    align-items: center;
}

.investor-item input {
    flex: 1;
}
</style>
{% endblock %}